<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div style="margin:20px">
        <input type="file" onchange="change(this)" style="width: 320px;"
          accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        <pre><p style="font-family: sans-serif;"></p></pre>
        </div>
    <script src="xlsx.full.min.js"></script>
    <script>
        var excelData;
        var colName=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","AA","AB","AC","AD","AE","AF","AG","AH","AI","AJ","AK","AL","AM","AN"];
        var startTime=[[0,0],[8,0],[9,0],[10,10],[11,10],[13,0],[14,0],[15,10],[16,10],[17,10],[18,40],[19,40],[20,40]];
        var endTime=[[0,0],[8,50],[9,50],[11,0],[12,0],[13,50],[14,50],[16,0],[17,0],[18,0],[19,30],[20,30],[21,30]];

        function change(obj) {
            if (!obj.files) {
                return;
            }
            var file = obj.files[0];
            var reader = new FileReader();
            function convertDate(year, month, day, hour, minute){
                var s="";
                s+=year;
                if(month<10) s+="0";
                s+=month;
                if(day<10) s+="0";
                s+=day;
                s+="T";
                if(hour<10) s+="0";
                s+=hour;
                if(minute<10) s+="0";
                s+=minute;
                s+="00";
                return s;
            }
            reader.onload = function (e) {
                var data = e.target.result;
                excelData = XLSX.read(data, {
                    type: 'binary'
                });
                //console.log(excelData);
                //excelData.SheetNames[0]是获取Sheets中第一个Sheet的名字
                //excelData.Sheets[Sheet名]获取第一个Sheet的数据
                //var json = XLSX.utils.sheet_to_json(excelData.Sheets[excelData.SheetNames[0]]);
                //document.querySelector("p").innerHTML = JSON.stringify(json, null, "\t");
                var curSheet=excelData.Sheets[excelData.SheetNames[0]];
                console.log(curSheet);
                var mergeInfo=new Array();
                for(var i=0;i<32;++i){
                    mergeInfo[i]=new Array();
                }

                for(var i=0,len=curSheet["!merges"].length;i<len;++i){
                    //console.log(curSheet["!merges"][i]);
                    var m=curSheet["!merges"][i];
                    if(m.s.c>=2&&m.s.c<=31&&m.s.r>=2&&(m.s.r-1)%15>=4){
                        for(var j=m.s.c; j<=m.e.c;++j){
                            mergeInfo[j].push({x1:m.s.c, y1:m.s.r, x2:m.e.c, y2:m.e.r});
                        }
                        //var cellName=colName[m.s.c]+(m.s.r+1);
                        //alert(cellName);
                        //console.log(curSheet[cellName])
                    }
                }
                console.log(mergeInfo);
                
                var curRow=3;
                var ans="";

                var curDate=new Date();
                var timeStamp=curDate.getTime();

                ans+="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:TPLink\nMETHOD:PUBLISH\nX-WR-CALNAME:Time Schedule\n";
                while(1){
                    var startCellName=colName[0]+curRow;
                    if(typeof(curSheet[startCellName])=="undefined"){
                        break;
                    }
                    //console.log(curRow);
                    for(var i=3;i<=31;++i){
                        for(var j=3;j<=13;++j){
                            var cellName=colName[i-1]+(curRow+j);
                            if(typeof(curSheet[cellName])!="undefined"){
                                if(curSheet[cellName].v.trim().length==0) continue;
                                var dateStr=curSheet[colName[i-1]+(curRow+1)].v;
                                dateStr=dateStr.split("-");
                                
                                var start=new Date(2022,parseInt(dateStr[0])-1,parseInt(dateStr[1]),startTime[j-2][0],startTime[j-2][1],0,0);
                                var end,flag=0;
                                for(var k=0, len=mergeInfo[i-1].length;k<len;++k){
                                    if(curRow+j-1>=mergeInfo[i-1][k].y1&&curRow+j-1<=mergeInfo[i-1][k].y2){
                                        end=new Date(start.getTime()+(mergeInfo[i-1][k].x2-(i-1))*24*60*60*1000);
                                        end.setHours(endTime[mergeInfo[i-1][k].y2-curRow-1][0]);
                                        end.setMinutes(endTime[mergeInfo[i-1][k].y2-curRow-1][1]);
                                        flag=1;
                                        break;
                                    }
                                }
                                if(!flag){
                                    end=new Date(start.getTime());
                                    end.setHours(endTime[j-2][0]);
                                    end.setMinutes(endTime[j-2][1]);
                                    console.log(start, end, curSheet[cellName].v,flag,j);
                                }

                               

                                ans+="BEGIN:VEVENT\n";
                                ans+="SUMMARY:"+curSheet[cellName].v.trim().replaceAll('\n'," ")+"\n";
                                ans+="DESCRIPTION:\n";
                                ans+="DTSTART;VALUE=DATE-TIME:"+convertDate(start.getFullYear(),start.getMonth()+1,start.getDate(),start.getHours(),start.getMinutes())+"\n";
                                ans+="DTEND;VALUE=DATE-TIME:"+convertDate(end.getFullYear(),end.getMonth()+1,end.getDate(),end.getHours(),end.getMinutes())+"\n";
                                ans+="DTSTAMP;VALUE=DATE-TIME:"+convertDate(curDate.getFullYear(), curDate.getMonth()+1, curDate.getDate(), curDate.getHours(), curDate.getMinutes())+"Z\n";
                                ans+="UID:"+window.btoa(unescape(encodeURIComponent(curSheet[cellName].v+timeStamp+i+","+j+",")))+Math.random()+"__TPLink"+"\n";
                                ans+="TRANSP:OPAQUE\n";
                                ans+="CLASS:PRIVATE\n";
                                ans+="END:VEVENT\n";
                            }
                        }
                    }
                   

                    curRow+=15;
                }
                ans+="END:VCALENDAR\n";
                const blob = new Blob([ans], { type: 'text/calendar' });
                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = 'Calendar.ics';
                link.click();
                console.log(curRow);

            };
            reader.readAsBinaryString(file);
        }
    </script>
</body>
</html>